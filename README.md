# Подготовка среды

Настроим docker-compose файл, в котором в качестве сервисов будет: postgres и server. Настроим постоянное хранение, сетевое окружение и healthckecks. Для server настроим Dockerfile с необходимой версией питона (облегченной) и необходимыми библиотеками. В app.py находится логика приложения: при помощи Flask будет подниматься сервер, из postgres будем получать ФИО, формировать HTML страницу для возврата.

Сделаем сборку server  
   <img width="981" alt="Снимок экрана 2024-03-16 в 15 10 05" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/bd1df931-6116-43a4-ab60-23aa7341a6e3">

   
С помощью команды docker-compose up -d развернем сервисы. В браузере по адресу localhost:5001 увидим результат
   <img width="986" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/0b544a26-d45f-4bd5-892b-2e46ad06976c">

   
# Trivy

Установим trivy.

<img width="976" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/547d3429-2388-4e06-b00f-0f6f3fe80bd2">


Запустим сканирование. В начале произойдет загрузка БД с уязвимостями. Далее появятся найденные уязвимости.

<img width="987" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/3755c552-b0fb-4586-8da5-c0ca96712a50">


Результат сканирования:

**server:latest (alpine 3.18.6)**
  
В библиотеке libexpat (свободная потокоориентированная библиотека парсинга XML) будет найдено две уязвимости:

1. CVE-2023-52425 - Неконтроллируемое потребление ресурсов - Продукт не контролирует должным образом распределение и обслуживание ограниченного ресурса, тем самым позволяя субъекту влиять на количество потребляемых ресурсов, что в конечном итоге приводит к исчерпанию доступных ресурсов.
Решение: уязвимость существует до версии 2.5.0, необходимо использовать библиотеку, начиная с версии 2.6.0 (написать Dockerfile, где прописать обновление)

2. CVE-2023-52426 - Неправильное ограничение рекурсивных ссылок на сущности в DTD (XML Entity Expansion) - Продукт использует XML-документы и позволяет определять их структуру с помощью определения типа документа (DTD), но не контролирует должным образом количество рекурсивных определений сущностей.
Решение: уязвимость существует до версии 2.5.0, необходимо использовать библиотеку, начиная с версии 2.6.0 (написать Dockerfile, где прописать обновление)

**Python (python-pkg)**
  
В библиотеке pip (METADATA) найдена одна уязвимость:

1. CVE-2023-5752 -Неправильная нейтрализация специальных элементов, используемых в команде (внедрение в команду) - Продукт полностью или частично создает команду, используя входные данные вышестоящего компонента, но не нейтрализует или неправильно нейтрализует специальные элементы, которые могут изменить предполагаемую команду при ее отправке нижестоящему компоненту.
Решение: уязвимость существует до версии 23.3, необходимо использовать библиотеку, начиная с версии 23.3. (написать Dockerfile, где прописать обновление)

# bench-security

В отдельную папку склонируем репозиторий утилиты bench-security

<img width="594" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/8d9d7add-8f71-4102-a78e-07b1f15ccc20">


Запустим ее:

<img width="698" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/1a402789-4401-43cd-8c0c-676707c15479">


Получим счет:

<img width="144" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/2ba648ae-685c-4553-bc74-6a03581c0f62">


В результате работы программы видим следующие предупреждения:


**1.1.1 - Ensure a separate partition for containers has been created (Automated) - "Убедитесь, что отдельное разделение для контейнеров было создано (Автоматизировано)."**

<img width="621" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/71179906-0f0e-4324-b067-5b819f94fc93">

Степень риска: Это предупреждение связано с безопасностью и изоляцией контейнеров. Отсутствие отдельного разделения может увеличить вероятность воздействия компрометированного контейнера на другие системы или контейнеры.

Как исправить:
1. Настройка отдельного разделения: Создайте отдельный раздел для контейнеров, чтобы изолировать их работу от других систем. Это поможет предотвратить распространение проблем между контейнерами.
2. Использование инструментов управления: Воспользуйтесь инструментами управления контейнерами, которые позволяют настроить изоляцию и безопасность контейнеров, такими как Docker Compose или Kubernetes.

**1.1.3 - Ensure auditing is configured for the Docker daemon (Automated) - "Убедитесь, что настроен аудит для демона Docker (Автоматизировано)."**

<img width="557" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/bf4a2094-3fef-4ae1-b973-b3c2e6a4e9c9">

Степень риска: Отсутствие настроенного аудита для демона Docker может привести к неспособности отслеживать события, связанные с операциями Docker, что создает слепые пятна в безопасности и возможность упущения аномалий или атак.

Как исправить:
1. Настройка журналирования: Настройте аудит для демона Docker, чтобы записывать события, связанные с его работой. Это включает операции, авторизации, аутентификацию и другие важные действия.
2. Анализ и мониторинг: Организуйте мониторинг и анализ журналов аудита Docker, чтобы быстро обнаруживать подозрительную активность или нарушения безопасности.

**1.1.4 - Ensure auditing is configured for Docker files and directories -/run/containerd (Automated) - "Убедитесь, что настроен аудит для файлов и каталогов Docker - /run/containerd (Автоматизировано)."**

<img width="750" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/16890514-30b0-44ea-8d93-de36e49a2ef8">

Степень риска: Не настроенный аудит для файлов и каталогов Docker, таких как /run/containerd, означает, что возможны незамеченные изменения, атаки на файловую систему или несанкционированный доступ к системным ресурсам.

Как исправить:
1. Настройка аудита: Настройте аудит для файлов и каталогов, связанных с Docker, чтобы учитывать изменения, доступ и другие операции.
2. Мониторинг и анализ: Установите мониторинг на файловые системы Docker для выявления подозрительной активности или нарушений безопасности.

**2.2 - Ensure network traffic is restricted between containers on the default bridge (Scored) - "Убедитесь, что сетевой трафик ограничен между контейнерами на стандартном мосту (Оценено)."**

<img width="704" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/30aad4b3-6e9e-4798-8329-949fdb680e4c">

Степень риска: Ограничение сетевого трафика между контейнерами на стандартном мосту крайне важно для предотвращения несанкционированного доступа и распространения возможных угроз внутри контейнерной среды. Отсутствие такого ограничения может привести к уязвимостям в безопасности и утечкам данных между контейнерами.

Как исправить:
1. Сетевые политики: Настройте правила сетевого доступа и политики в вашей контейнерной среде для блокировки нежелательного трафика между контейнерами.
2. Использование сетевых абстракций: Рассмотрите использование сетевых абстракций и инструментов, таких как Docker network plugins или Kubernetes network policies, для более гранулированного управления сетевым трафиком между контейнерами.

**2.9 - Enable user namespace support (Scored) - "Включите поддержку пространств имен пользователей (Оценено)."**

<img width="363" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/3da7f04d-7ad2-48f5-a5b8-820a9c5d9851">

Степень риска: Отсутствие поддержки пространств имен пользователей (user namespace) может повысить риск компрометации безопасности контейнеров, так как это позволяет более гранулированно управлять разрешениями и доступом пользователей внутри контейнеров. Без этой функциональности атакующий может иметь повышенные привилегии в случае успешной атаки.

Как исправить:
1. Включение поддержки: Активируйте поддержку пространств имен пользователей в конфигурации Docker или другой контейнерной платформы.
2. Конфигурация пространств имен: Настройте подходящие параметры и политики для использования пространств имен пользователей в соответствии с требованиями вашей безопасности.

**2.12 - Ensure that authorization for Docker client commands is enabled (Scored) - "Убедитесь, что авторизация для команд клиента Docker включена (Оценено)."**

<img width="607" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/c3fa5dde-ed1a-452e-b69d-dd7b45a30966">

Степень риска: Неактивированная авторизация для команд клиента Docker может привести к возможности выполнения несанкционированных операций или изменений в контейнерах. Это создает риск для безопасности и целостности контейнерной среды.

Как исправить:
1. Настройка авторизации: Включите и настройте механизм авторизации для команд клиента Docker, чтобы контролировать доступ и операции.
2. Использование ролевых прав: Работайте с ролевыми правами и доступом, чтобы определить, какие пользователи или группы могут выполнять определенные операции.

**2.13 - Ensure centralized and remote logging is configured (Scored) - "Убедитесь, что настроено централизованное и удаленное журналирование (Оценено)."**

<img width="533" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/bc3cb34d-d9ad-4a3e-8881-17f1a1c6422e">

Степень риска: Отсутствие настроенного централизованного и удаленного журналирования может затруднить обнаружение и реакцию на события безопасности или проблемы в контейнерной среде. Это также усложняет мониторинг и анализ действий в контейнерах.

Как исправить:
1. Конфигурация журналирования: Настройте систему централизованного и удаленного журналирования, чтобы записывать и анализировать логи событий в контейнерах.
2. Резервное копирование логов: Убедитесь, что система журналирования настроена на регулярное резервное копирование логов для сохранения целостности данных.

**2.14 - Ensure containers are restricted from acquiring new privileges (Scored) -  "Убедитесь, что контейнерам запрещено приобретать новые привилегии (Оценено)."**

<img width="602" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/d0993017-d9a1-4d49-a3c7-b030954a291f">

Степень риска: Если контейнерам разрешено приобретать новые привилегии, это может увеличить уязвимости и повысить риск атак на вашу контейнерную среду. Неправильная конфигурация привилегий может привести к расширенным возможностям атаки и компрометации безопасности.

Как исправить:
1. Ограничение привилегий: Настройте контейнеры таким образом, чтобы они не могли приобретать новые привилегии во время выполнения.
2. Использование SELinux или AppArmor: Рассмотрите использование инструментов обязательного доступа, таких как SELinux или AppArmor, для управления привилегиями контейнеров.

**2.15 - Ensure live restore is enabled (Scored) - "Убедитесь, что включена возможность восстановления контейнеров в реальном времени (Оценено)."**

<img width="377" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/d2170f28-77d5-4baf-b49d-f5209f93d340">

Степень риска: Отсутствие включенной опции восстановления контейнеров в реальном времени (live restore) может привести к потере данных в случае сбоя или перезапуска Docker демона во время работы контейнеров. Это может вызвать проблемы с непрерывностью работы и потерю состояния приложений.

Как исправить:
Включение live restore: Убедитесь, что опция восстановления контейнеров в реальном времени включена в конфигурации Docker.

**2.16 - Ensure Userland Proxy is Disabled (Scored) - "Убедитесь, что Userland Proxy отключен (Оценено)."**

Степень риска: Включенный Userland Proxy может стать потенциальной точкой уязвимости и увеличить атаку на контейнеры, так как он делегирует сетевую обработку от ядра операционной системы к пользовательскому пространству, что может стать зоной риска.

<img width="396" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/8cadcf7f-4608-4a72-b7f9-c0c148cd8d3b">

Как исправить:
1. Отключение Userland Proxy: Убедитесь, что Userland Proxy отключен в настройках Docker для улучшения производительности и безопасности.
2. Использование режима проксирования: Рассмотрите использование других режимов проксирования (например, iptables) для обеспечения эффективного и безопасного сетевого взаимодействия.

**3.15 - Ensure that the Docker socket file ownership is set to root:docker (Automated) - "Убедитесь, что владелец файла сокета Docker установлен на root:docker (Автоматизировано)."**

<img width="654" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/0314f737-09b6-4178-8a0a-13199940b32b">

Степень риска: Неправильные права доступа к файлу сокета Docker (/var/run/docker.sock) могут повлечь за собой уязвимости и потенциальные атаки на систему через Docker API. Необходимо исправить владельца файла для обеспечения безопасности.

Как исправить:
1. Изменение владельца файла сокета: Выполните команду chown root:docker /var/run/docker.sock для установки правильных прав доступа к файлу сокета Docker.
2. Перезапуск Docker сервиса: После изменения прав на файл сокета, перезапустите сервис Docker, чтобы применить изменения.

**3.16 - Ensure that the Docker socket file permissions are set to 660 or more restrictively (Automated) - "Убедитесь, что права доступа к файлу сокета Docker установлены на 660 или более строго (Автоматизировано)."**

<img width="775" alt="image" src="https://github.com/irefuse3585/docker-vulnerabilities/assets/76556696/ec021f0e-f1ab-4cb8-bb6b-28bc71d13add">

Степень риска: Неправильные права доступа к файлу сокета Docker (/var/run/docker.sock) могут привести к раскрытию конфиденциальной информации, возможности атаки на Docker API и другим безопасностным угрозам. Необходимо скорректировать права доступа к файлу сокета для повышения безопасности.

Как исправить:
1. Изменение прав доступа к файлу сокета: Выполните команду chmod 660 /var/run/docker.sock для установки правильных прав доступа к файлу сокета Docker.
2. Проверка и обновление: Проверьте другие файлы и каталоги на соответствие правилам безопасности и исправьте их при необходимости.

**4.5 - Ensure Content trust for Docker is Enabled (Automated) - Убедитесь, что доверие к контенту для Docker включено (автоматически)**

Включение Content Trust для Docker — это отличная практика для обеспечения безопасности контейнеров. Content Trust используется для проверки подлинности и целостности образов Docker перед их загрузкой и запуском.
export DOCKER_CONTENT_TRUST=1
docker trust key generate <ИМЯ>
docker trust sign <ИМЯ_ОБРАЗА>:<ТЕГ>

**5.2 - Ensure that, if applicable, an AppArmor Profile is enabled (Automated) - Убедитесь, что, если применимо, профиль AppArmor включен (автоматически)**

**5.3 - Ensure that, if applicable, SELinux security options are set (Automated) - Убедитесь, что, если применимо, установлены параметры безопасности SELinux (автоматически)**

**5.8 - Ensure privileged ports are not mapped within containers (Automated) - Убедитесь, что привилегированные порты не отображаются внутри контейнеров (автоматически)**

**5.9 - Ensure that only needed ports are open on the container (Manual) - Убедитесь, что в контейнере открыты только необходимые порты (вручную)**

**5.11 - Ensure that the memory usage for containers is limited (Automated) - Убедитесь, что использование памяти для контейнеров ограничено (автоматизировано)**

**5.12 - Ensure that CPU priority is set appropriately on containers (Automated) - Убедитесь, что приоритет ЦП установлен правильно в контейнерах (автоматически)**

**5.13 - Ensure that the container's root filesystem is mounted as read only (Automated) - Убедитесь, что корневая файловая система контейнера смонтирована только для чтения (автоматически)**

**5.14 - Ensure that incoming container traffic is bound to a specific host interface (Automated) - Убедитесь, что входящий контейнерный трафик привязан к определенному интерфейсу хоста (автоматически)**

# docker-scout
Проверим уязвимости с помощью docker-scout. Для этого выберем образ и выполним анализ
В результате будут обнаружены те же самые уязвимости, что выявила утилита trivy

![изображение](https://github.com/Murken-0/docker-vulnerabilities/assets/71382530/377d99fa-6266-4c6b-b21e-f885d8f8d67a)
